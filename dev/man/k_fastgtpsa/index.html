<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>@FastGTPSA/@FastGTPSA! Macros · GTPSA.jl</title><meta name="title" content="@FastGTPSA/@FastGTPSA! Macros · GTPSA.jl"/><meta property="og:title" content="@FastGTPSA/@FastGTPSA! Macros · GTPSA.jl"/><meta property="twitter:title" content="@FastGTPSA/@FastGTPSA! Macros · GTPSA.jl"/><meta name="description" content="Documentation for GTPSA.jl."/><meta property="og:description" content="Documentation for GTPSA.jl."/><meta property="twitter:description" content="Documentation for GTPSA.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">GTPSA.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../quickstart/">Quickstart Guide</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../a_toc/">Table of Contents</a></li><li><a class="tocitem" href="../b_definitions/">Definitions</a></li><li><a class="tocitem" href="../c_descriptor/"><code>Descriptor</code></a></li><li><a class="tocitem" href="../d_tps/"><code>TPS</code></a></li><li><a class="tocitem" href="../e_varsparams/"><code>vars</code>, <code>params</code></a></li><li><a class="tocitem" href="../f_monoindex/">Monomial Indexing</a></li><li><a class="tocitem" href="../g_mono/"><code>mono</code>/<code>complexmono</code></a></li><li><a class="tocitem" href="../h_gjh/"><code>gradient</code>, <code>jacobian</code>, <code>hessian</code></a></li><li><a class="tocitem" href="../i_slice/">Slicing and <code>par</code></a></li><li><a class="tocitem" href="../j_methods/">TPS Methods</a></li><li class="is-active"><a class="tocitem" href><code>@FastGTPSA</code>/<code>@FastGTPSA!</code> Macros</a><ul class="internal"><li><a class="tocitem" href="#Documentation"><span>Documentation</span></a></li></ul></li><li><a class="tocitem" href="../l_io/">I/O</a></li><li><a class="tocitem" href="../m_global/">Global Variables</a></li><li><a class="tocitem" href="../n_all/">All Overloaded Functions</a></li></ul></li><li><a class="tocitem" href="../../devel/">For Developers</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href><code>@FastGTPSA</code>/<code>@FastGTPSA!</code> Macros</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href><code>@FastGTPSA</code>/<code>@FastGTPSA!</code> Macros</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/bmad-sim/GTPSA.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/bmad-sim/GTPSA.jl/blob/main/docs/src/man/k_fastgtpsa.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="fastgtpsa"><a class="docs-heading-anchor" href="#fastgtpsa"><code>@FastGTPSA</code>/<code>@FastGTPSA!</code> Macros</a><a id="fastgtpsa-1"></a><a class="docs-heading-anchor-permalink" href="#fastgtpsa" title="Permalink"></a></h1><p><em>Speed up evaluation of expressions containing TPSs, transparent to other types</em></p><p>The thread-safe macros <a href="#fastgtpsa"><code>@FastGTPSA</code>/<code>@FastGTPSA!</code></a> can be used to speed up evaluation of expressions that may contain <code>TPS</code>s. <strong>Both macros are completely transparent to all other types, so they can be prepended to any existing expressions while still maintaining type-generic code.</strong> Any functions in the expression that are not overloaded by GTPSA will be ignored. Both macros do <strong>not</strong> use any <code>-ffast-math</code> business (so still IEEE compliant), but instead will use a thread-safe pre-allocated buffer in the <code>Descriptor</code> for any temporaries that may be generated during evaluation of the expression.</p><p>The first macro, <code>@FastGTPSA</code> can be prepended to an expression following assignment (<code>=</code>, <code>+=</code>, etc) to only construct one <code>TPS</code> (which requires two allocations), instead of a <code>TPS</code> for every temporary:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; using GTPSA, BenchmarkTools</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; d = Descriptor(3, 7);  x = vars(d);</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;</code><code class="nohighlight hljs ansi" style="display:block;">  5.863 μs (20 allocations: 11.88 KiB)</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime @FastGTPSA $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;</code><code class="nohighlight hljs ansi" style="display:block;">  5.492 μs (2 allocations: 1.94 KiB)</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; y = rand(3); # transparent to non-TPS types</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime $y[1]^3*sin($y[2])/log(2+$y[3])-exp($y[1]*$y[2])*im;</code><code class="nohighlight hljs ansi" style="display:block;">  19.204 ns (0 allocations: 0 bytes)</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime @FastGTPSA $y[1]^3*sin($y[2])/log(2+$y[3])-exp($y[1]*$y[2])*im;</code><code class="nohighlight hljs ansi" style="display:block;">  20.389 ns (0 allocations: 0 bytes)</code></pre><p>The second macro, <code>@FastGTPSA!</code> can be prepended to the LHS of an assignment, and will fill a preallocated <code>TPS</code> with the result of an expression. <code>@FastGTPSA!</code> will calculate a <code>TPS</code> expression with <em>zero</em> allocations, and will still have no impact if a non-TPS type is used. The only requirement is that all symbols in the expression are defined:</p><pre><code class="nohighlight hljs ansi" style="display:block;"></code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; t = ComplexTPS64(); # pre-allocate</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime @FastGTPSA! $t = $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;</code><code class="nohighlight hljs ansi" style="display:block;">  5.337 μs (0 allocations: 0 bytes)</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; y = rand(3); @gensym z; # transparent to non-TPS types</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime @FastGTPSA! $z = $y[1]^3*sin($y[2])/log(2+$y[3])-exp($y[1]*$y[2])*im;</code><code class="nohighlight hljs ansi" style="display:block;">  19.424 ns (0 allocations: 0 bytes)</code></pre><p>Both <code>@FastGTPSA</code> and <code>@FastGTPSA!</code> can also be prepended to a block of code, in which case they are applied to each assignment in the block:</p><pre><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; d = Descriptor(3, 7); x = vars(d);</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; y = rand(3);</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime @FastGTPSA begin
               t1 = $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
               t2 = $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
               z  = $y[1]^3*sin($y[2])/log(2+$y[3])-exp($y[1]*$y[2])*im;
              end;</code><code class="nohighlight hljs ansi" style="display:block;">  11.101 μs (4 allocations: 3.88 KiB)</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; t3 = ComplexTPS64(); t4 = ComplexTPS64(); @gensym w;</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime @FastGTPSA! begin
               $t3 = $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
               $t4 = $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
               $w  = $y[1]^3*sin($y[2])/log(2+$y[3])-exp($y[1]*$y[2])*im;
              end;</code><code class="nohighlight hljs ansi" style="display:block;">  10.830 μs (0 allocations: 0 bytes)</code></pre><p>Without using the macro, each time an operation is performed using a TPS, a new TPS is dynamically-allocated containing the result. For example in the above expression, the calculation of <code>sin(x[2])</code> creates a new TPS, and the calculation of <code>x[1]^3</code> also creates a new TPS. The multiplication of these two resulting TPSs creates a new TPS, and so on until a TPS containing the full result of the evaluated expression is obtained. The intermediate TPSs that must be created to evaluate the expression are referred to as <em>temporaries</em>, because they only exist temporarily. Julia&#39;s garbage collector notices when the dynamically-allocated temporaries are no longer in scope, and cleans up that memory when it decides it&#39;s a good time to. This process can cause slowdowns in performance critical code however, especially in more complicated expressions where a lot of temporaries are created.</p><p>Both <code>@FastGTPSA</code> and <code>@FastGTPSA!</code> basically tell the code to instead use a permanent, pre-allocated thread-safe buffer of TPSs for the temporaries during evaluation of the expression, so there is no dynamic memory allocation; for <code>@FastGTPSA</code>, the number of allocations is reduced to two (which is one single <code>TPS</code>), and for <code>@FastGTPSA!</code> the number of allocations is zero. Furthermore, these temporaries are accessed and deleted in a stack-like manner from the buffer by each thread, so that temporaries involved in operations are right next to each other in memory. This ensures minimal cache misses throughout the evaluation of the expression.</p><p>The speedup of using the macro can be quite significant. See our <a href="https://github.com/bmad-sim/GTPSA.jl/blob/main/benchmark/track.jl">example</a>, where we observe a x2 speedup at 2nd order. </p><h2 id="Documentation"><a class="docs-heading-anchor" href="#Documentation">Documentation</a><a id="Documentation-1"></a><a class="docs-heading-anchor-permalink" href="#Documentation" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="GTPSA.@FastGTPSA" href="#GTPSA.@FastGTPSA"><code>GTPSA.@FastGTPSA</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@FastGTPSA(expr_or_block)</code></pre><p>Macro to speed up evaluation of mathematical expressions containing TPSs. The temporaries generated during evaluation of the expression are drawn  from a thread-safe buffer, reducing the number of heap allocations to  2 (which is for a single TPS) for the result. @FastGTPSA is completely  transparent to all other types, so it can be prepended to expressions  while still maintaining type-generic code.</p><pre><code class="language-julia-repl hljs">julia&gt; using GTPSA, BenchmarkTools

julia&gt; d = Descriptor(3,7); x = vars(d);

julia&gt; t = @btime $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
  3.458 μs (20 allocations: 11.88 KiB)

julia&gt; t = @btime @FastGTPSA $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
  3.172 μs (2 allocations: 1.94 KiB)</code></pre><p><code>@FastGTPSA</code> can also be prepended to a block of code, in which case it  is applied after every <code>=</code> sign in the block: </p><pre><code class="language-julia-repl hljs">julia&gt; @btime @FastGTPSA begin
       t1 = $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
       t2 = $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
       a = t1+t2
       L = 5+3*exp(7)
       end
  6.317 μs (6 allocations: 5.81 KiB)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/bmad-sim/GTPSA.jl/blob/242e05f745449743e51420dfec569d70cc01b461/src/fastgtpsa/fastgtpsa.jl#L1-L35">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="GTPSA.@FastGTPSA!" href="#GTPSA.@FastGTPSA!"><code>GTPSA.@FastGTPSA!</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@FastGTPSA!(expr_or_block)</code></pre><p>Macro to speed up evaluation of mathematical expressions that may contain assignment to pre-allocated <code>TPS</code>s. The temporaries generated during  evaluation of the expression are drawn from a thread-safe buffer. With this  macro, the number of heap allocations during evaluation of expressions  containing <code>TPS</code>s is 0, and it is fully transparent to non-TPS types.</p><p>This macro supports assignment using <code>=</code>, <code>+=</code>, <code>-=</code>, <code>*=</code>, <code>/=</code>, and <code>^=</code>.</p><p><strong>Important:</strong> The symbols must be defined prior to calling the macro  regardless of whether or not the type is a <code>TPS</code>:</p><pre><code class="language-julia-repl hljs">julia&gt; using GTPSA, BenchmarkTools

julia&gt; d = Descriptor(3,7); x = vars(d); 

julia&gt; t = ComplexTPS64(); # Pre-allocate

julia&gt; @btime @FastGTPSA! $t = $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
  2.972 μs (0 allocations: 0 bytes)

julia&gt; @btime @FastGTPSA! $t ^= $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
  6.550 μs (0 allocations: 0 bytes)

julia&gt; y = rand(3); z = 2; # transparent to non-TPS types 

julia&gt;  @btime @FastGTPSA! $z = $y[1]^3*sin($y[2])/log(2+$y[3])-exp($y[1]*$y[2])*im;
  11.344 ns (0 allocations: 0 bytes)</code></pre><p>Like <code>@FastGTPSA</code>, <code>@FastGTPSA!</code> can prepended to a block of code, in  which case it is applied before every line in the block containing assignment:</p><pre><code class="language-julia-repl hljs">julia&gt; t1 = zero(ComplexTPS64); t2 = zero(ComplexTPS64); z = 0; 

julia&gt; @btime @FastGTPSA! begin
       $t1 = $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
       $t2 -= $x[1]^3*sin($x[2])/log(2+$x[3])-exp($x[1]*$x[2])*im;
       $z += 7
       end
  5.965 μs (0 allocations: 0 bytes)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/bmad-sim/GTPSA.jl/blob/242e05f745449743e51420dfec569d70cc01b461/src/fastgtpsa/fastgtpsa.jl#L49-L95">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../j_methods/">« TPS Methods</a><a class="docs-footer-nextpage" href="../l_io/">I/O »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Thursday 8 August 2024 00:56">Thursday 8 August 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
